import { ModelController } from "./ModelController";
import { Model } from "sequelize";
import { Request, Response } from "express";
import { BaseController, handleServerError } from "./BaseController";
import { Get, Put, Delete, Authentication, Post, Middlewares } from "../routes/decorators";
let hasAdminAccess;
@Authentication()
export class ModelAdminController<T extends Model> extends ModelController<T> {
  protected modelSchema: object;
  constructor(validateJWT, authorize, hasAdminAccessPr, db, percentEncode, config) {
    super(validateJWT, authorize, db, percentEncode, config);
    hasAdminAccess = hasAdminAccessPr;
  }
  @Get("/")
  @Middlewares([hasAdminAccess()])
  getUsers = (req: Request, res: Response) => {
    this.handleFindAll(req, res);
  };
  @Post("/")
  @Middlewares([hasAdminAccess()])
  postUser = (req: Request, res: Response) => {
    this.handleCreate(req, res);
  };
  @Get("/schema")
  @Middlewares([hasAdminAccess()])
  getSchema = (req: Request, res: Response) => {
    this.handleGetSchema(req, res);
  };
  @Get("/:id")
  @Middlewares([hasAdminAccess()])
  getUser = (req: Request, res: Response) => {
    this.handleFindOne(req, res);
  };
  @Put("/:id")
  @Middlewares([hasAdminAccess()])
  updateUser = (req: Request, res: Response) => {
    this.handleUpdate(req, res);
  };
  @Delete("/:id")
  @Middlewares([hasAdminAccess()])
  deleteUser = (req: Request, res: Response) => {
    this.handleDelete(req, res);
  };
  handleGetSchema(req: Request, res: Response) {
    try {
      //only compute schema the first time
      if (!this.modelSchema) {
        this.generateSchema();
      }
      return BaseController.ok(res, this.modelSchema);
    } catch (err) {
      handleServerError(err, res);
    }
  }
  generateSchema() {
    const attributes = this.model.rawAttributes;
    let schema = {};
    Object.keys(attributes).forEach(attribute => {
      let type = attributes[attribute].type.constructor.name.toLowerCase();
      //@ts-ignore
      if (attributes[attribute]._modelAttribute === true) {
        schema[attribute] = formatSchemaAttribute(type, attribute, attributes);
      }
    });
    this.modelSchema = schema;
  }
}

function formatSchemaAttribute(type, attribute, attributes) {
  return {
    type,
    readOnly: attributes[attribute]._autoGenerated ?? false,
    fieldName: attributes[attribute].field,
    allowNull: attributes[attribute].allowNull,
    values: attributes[attribute].values,
    defaultValue: attributes[attribute].defaultValue,
    validate: attributes[attribute].validate,
    references: attributes[attribute].references,
    primaryKey: attributes[attribute].primarykey,
    autoGenerated: attributes[attribute]._autoGenerated,
  };
}
